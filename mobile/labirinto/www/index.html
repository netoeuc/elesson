<!DOCTYPE html>
<html>
<!--
  * Please see the included README.md file for license terms and conditions.
  -->
<head>
    <title>Blank Cordova Mobile App Project Template (Lite)</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">

    
    <!-- see http://webdesign.tutsplus.com/tutorials/htmlcss-tutorials/quick-tip-dont-forget-the-viewport-meta-tag -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <style>
        
        /* following two viewport lines are equivalent to the meta viewport statement above, needed for Windows */
        /* see http://www.quirksmode.org/blog/archives/2014/05/html5_dev_conf.html and http://dev.w3.org/csswg/css-device-adapt/ */
        @-ms-viewport { width: 100vw ; zoom: 100% ; }  @viewport { width: 100vw ; zoom: 100% ; }
        @-ms-viewport { user-zoom: fixed ; }           @viewport { user-zoom: fixed ; }
    </style>
    
    
    <script src="cordova.js"></script>          <!-- phantom library, needed for Cordova api calls, added during build -->
    <script src="js/app.js"></script>           <!-- recommended location of your JavaScript code relative to other JS files -->
    <script src="xdk/init-dev.js"></script>     <!-- normalizes device and document ready events, see README for details -->
     <script type="text/javascript" src="materialize/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="materialize/js/materialize.min.js"></script>
    <script type="text/javascript" src="materialize/js/elessons.js"></script>
     
    <!--Import Google Icon Font-->
      <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
   <link href="materialize/css/icon.css" rel="stylesheet">
      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="materialize/css/elessons.css"  media="screen,projection"/>

    <link type="text/css" rel="stylesheet" href="materialize/css/materialize.min.css"  media="screen,projection"/>
    
      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

</head>

<body class="bg-aula" onload="onload();">

 
			<div class="container">
                
			
				<div> 
                <br/>
                    <br/>
                    <br/>
                </div>
		        
				<!-- CARD LOGIN -->
		        <div class="row" style="margin-bottom:0px !important;">
		          <div class="col s12 offset-m3 m6">
		            <div class="card defaultCard default-page-margin-top hoverable">
		              <div class="card-content center-align">
		
		             <i class="large material-icons">perm_identity</i><br/>
                          <!-- <i class="large fa fa-user" style="margin-bottom: 5px;"></i><br/> -->
		                <span class="card-title" style="line-height: 80%; letter-spacing: 3px;">Student</span>
		
		                <div class="row">
		                  <div class="col s12">
		                  		
		                    <div class="row" style="margin-bottom: 10px !important;">
		                      <div class="input-field col s12 offset-m1 m10">
		                        <input id="login" name="login" autocomplete="off" type="text" value=""/>
		                        <label for="login">Login</label>
		                      </div>
		                    </div>
		
		                    <div class="row" style="margin-bottom: 10px !important;">
		                      <div class="input-field col s12 offset-m1 m10">
		                        <input id="password" name="password" type="password" value=""/>
		                        <label for="password">Password</label>
		                      </div>
		                    </div>
		                    
		                   	<!--<div class="row" style="margin-bottom: 3px !important;">
		                  	  <div class="col s12 offset-m1 m10">
								<select name="inst" class="browser-default color-vermelho">
								  <option disabled selected>Choose your institute</option>
								  @for(i <- li){							  
								  <option value="@i.getCnpj">@i.getNome</option>
								  }
								</select>
							  </div>
		                    </div> -->
		
				            <div class="row">
				            	<div class="input-field col s12">
				                	<button type="button" onclick="kk();" class="waves-effect waves-light btn btn-medium bg-vermelho">go</button>
								</div>
							</div>
		
		                    <div class="card-action" style="margin-bottom: -35px !important;">
		                      <a href="#" onClick='http://54.187.59.145:9000/panel/teacher/forgot'>Forgot your password?</a>
		                    </div>
		
		                  </div>

		                </div>
		
		              </div>
		            </div>
		          </div>
		        </div><!-- FIM card -->
	
			</div>

    
    <!--Import jQuery before materialize.js-->
      <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
      <script type="text/javascript" src="materialize/js/materialize.min.js"></script>
    <script src="frameworks/cocos2d-js.js"></script>
      <script type='text/javascript' src='src/variaveis.js'></script>
      <script type="text/javascript">
                    
                    
                    var conector = false;
                    function kk(){
                        var senha = document.getElementById('password').value;
                        var email = document.getElementById('login').value;
                        var sessaoFinal = email +""+ new Date().getTime();
                        //var sessaoFinal = email +"1234";
                        
                        if(senha == "" || email == ""){
                            alert("Preencha todos os campos");
                        }else{
                            var xhr = XMLHttpRequest();

                            xhr.open( "POST", "http://54.187.59.145:9000/api/student/auth" );
                            xhr.setRequestHeader( "Content-Type", "application/x-www-form-urlencoded" );
                            var arguements = "email="+email+"&senha="+senha+"&sessao="+sessaoFinal;
                            xhr.send( arguements );

                            xhr.onreadystatechange = function (){
                            
                                //console.log( "Networking away" );

                                if ( xhr.readyState == 4 && ( xhr.status >= 200 && xhr.status <= 207 ) ) {
                                    
                                    conector = true;
                                
                                    var httpStatus = xhr.statusText;
                                    //console.log( httpStatus );

                                    var response = JSON.parse(xhr.responseText);
                                    //console.log( response );
                                    if(response.hasOwnProperty('mensagem') && response.mensagem == "Você já está logado em outro dispositivo. Deseja iniciar uma nova sessão para este dispositivo?"){
                                        if(confirm(response.mensagem)){  
                                            var xhr2 = XMLHttpRequest();
                                            xhr2.open( "POST", "http://54.187.59.145:9000/api/student/auth" );
                                            xhr2.setRequestHeader( "Content-Type", "application/x-www-form-urlencoded" );
                                            var arguements2 = "email="+email+"&senha="+senha+"&sessao="+sessaoFinal+"&isNSessao=true";
                                            xhr2.send( arguements2 );
                                            
                                            xhr2.onreadystatechange = function (){
                                                if ( xhr2.readyState == 4 && ( xhr2.status >= 200 && xhr2.status <= 207 ) ) {
                                                    var response2 = JSON.parse(xhr2.responseText);
                                                   
                                                    if(response2.hasOwnProperty('aluno') && response2.aluno.logado){
                                                        console.log(response2);
                                                        console.log(response2.aluno.id);
                                                        //cc.sys.localStorage.setItem("idAluno",response2.aluno.id);
                                                        userInfo.setItem("idAluno",response2.aluno.id);
                                                        userInfo.setItem("status",response2.aluno.level);
                                                        console.log("Imprimindo id do aluno");
                                                        console.log(userInfo.getItem("idAluno"));
                                                        console.log(userInfo.getItem("status"));
                                                        status = userInfo.getItem("status");
                                                        //gravar no arquivo response2
                                                        
                                                        window.location.assign("index2.html");
                                                    }else{
                                                        
                                                        alert(response2.mensagem);
                                                    }
                                                        
                                                        
                                                }else if(xhr2.status == 400){
                                                    alert("Ocorreu um erro na autenticação. Tente novamente.");
                                                    //console.log(JSON.parse(xhr2.responseText));
                                                }else{
                                                    conetor = false;
//                                                    alert("Sem conexão");
                                                }
                                            }
   
                                        }
                                                   
                                    }else if(response.hasOwnProperty('aluno') && response.aluno.logado){
                                        
                                        
                                        //gravar no arquivo response

                                        
                                        window.location.assign("index2.html");
                                    }else{
                                        alert(response.mensagem);
                                    }

                                }else if(xhr.status == 400){
                                    alert("Ocorreu um erro na autenticação. Tente novamente.");
                                    //console.log(JSON.parse(xhr.responseText));
                                }else{
                                    conector = false;
//                                    alert("Sem conexão");
                                }        
                            }        
                        }
                        checarConexao();
                    }
          function checarConexao(){
                setTimeout(function(){
                if(!conector){
                    alert("sem conexão!");
                }
    
                }, 20000);};
          

                </script>
</body>
</html>




